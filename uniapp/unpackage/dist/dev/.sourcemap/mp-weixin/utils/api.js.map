{"version":3,"file":"api.js","sources":["utils/api.js"],"sourcesContent":["// API service for UniApp to communicate with backend server\nimport { getBaseUrl, getPlatform, checkPlatformSupport } from './config.js'\n\nconst BASE_URL = getBaseUrl(); // 动态获取API基础URL\nconst CURRENT_PLATFORM = getPlatform();\n\n// 通用请求函数\nfunction request(url, options = {}) {\n\treturn new Promise((resolve, reject) => {\n\t\t// 检查网络协议支持\n\t\tconst isHttps = BASE_URL.startsWith('https://');\n\t\tconst isHttp = BASE_URL.startsWith('http://');\n\t\t\n\t\t// 小程序环境检查HTTPS要求\n\t\tif (!isHttps && CURRENT_PLATFORM.startsWith('mp-')) {\n\t\t\tconsole.warn(`警告: ${CURRENT_PLATFORM} 平台要求使用HTTPS协议`);\n\t\t\t// 在小程序环境下，如果是HTTP，尝试转换为HTTPS\n\t\t\tif (isHttp) {\n\t\t\t\tconst httpsUrl = BASE_URL.replace('http://', 'https://');\n\t\t\t\tconsole.log(`自动转换为HTTPS: ${httpsUrl}`);\n\t\t\t}\n\t\t}\n\t\t\n\t\tconst config = {\n\t\t\turl: BASE_URL + url,\n\t\t\tmethod: options.method || 'GET',\n\t\t\theader: {\n\t\t\t\t'Content-Type': 'application/json',\n\t\t\t\t// 添加平台标识\n\t\t\t\t'X-Platform': CURRENT_PLATFORM,\n\t\t\t\t'X-Client': 'UniApp-WhatToEat',\n\t\t\t\t...options.header\n\t\t\t},\n\t\t\ttimeout: getPlatformTimeout(),\n\t\t\tsuccess: (res) => {\n\t\t\t\tconsole.log(`[${CURRENT_PLATFORM}] API ${options.method || 'GET'} ${url}:`, res.statusCode);\n\t\t\t\tif (res.statusCode === 200) {\n\t\t\t\t\tresolve(res.data);\n\t\t\t\t} else {\n\t\t\t\t\tconst errorMsg = getPlatformErrorMessage(res.statusCode, res.data);\n\t\t\t\t\treject(new Error(errorMsg));\n\t\t\t\t}\n\t\t\t},\n\t\t\tfail: (err) => {\n\t\t\t\tconsole.error(`[${CURRENT_PLATFORM}] Request failed:`, err);\n\t\t\t\tconst errorMsg = getPlatformNetworkError(err);\n\t\t\t\treject(new Error(errorMsg));\n\t\t\t}\n\t\t};\n\t\t\n\t\t// 根据请求方法设置数据\n\t\tif (options.method === 'GET') {\n\t\t\tconfig.data = options.data || {};\n\t\t} else {\n\t\t\tconfig.data = options.data || {};\n\t\t}\n\t\t\n\t\tconsole.log(`[${CURRENT_PLATFORM}] API Request: ${config.method} ${config.url}`, config.data);\n\t\tuni.request(config);\n\t});\n}\n\n// 获取平台特定的超时时间\nfunction getPlatformTimeout() {\n\tswitch (CURRENT_PLATFORM) {\n\t\tcase 'mp-weixin':\n\t\tcase 'mp-alipay':\n\t\tcase 'mp-baidu':\n\t\tcase 'mp-toutiao':\n\t\tcase 'mp-qq':\n\t\tcase 'mp-kuaishou':\n\t\t\treturn 20000; // 小程序网络较慢，增加超时时间\n\t\tcase 'h5':\n\t\t\treturn 10000; // H5默认超时\n\t\tcase 'app-plus':\n\t\t\treturn 15000; // App环境\n\t\tdefault:\n\t\t\treturn 10000;\n\t}\n}\n\n// 获取平台特定的错误信息\nfunction getPlatformErrorMessage(statusCode, data) {\n\tconst baseMsg = `HTTP ${statusCode}: ${data?.message || 'Request failed'}`;\n\t\n\tswitch (CURRENT_PLATFORM) {\n\t\tcase 'mp-weixin':\n\t\t\tif (statusCode === 600) {\n\t\t\t\treturn '微信小程序网络超时，请检查网络连接';\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 'mp-alipay':\n\t\t\tif (statusCode === 11) {\n\t\t\t\treturn '支付宝小程序网络异常，请稍后重试';\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 'h5':\n\t\t\tif (statusCode === 0) {\n\t\t\t\treturn '网络连接失败，请检查CORS配置或网络状态';\n\t\t\t}\n\t\t\tbreak;\n\t}\n\t\n\treturn baseMsg;\n}\n\n// 获取平台特定的网络错误信息\nfunction getPlatformNetworkError(err) {\n\tswitch (CURRENT_PLATFORM) {\n\t\tcase 'mp-weixin':\n\t\t\tif (err.errMsg?.includes('timeout')) {\n\t\t\t\treturn '微信小程序请求超时，请检查网络连接';\n\t\t\t}\n\t\t\tif (err.errMsg?.includes('fail')) {\n\t\t\t\treturn '微信小程序网络请求失败，请检查服务器域名是否已配置';\n\t\t\t}\n\t\t\tbreak;\n\t\t\t\n\t\tcase 'mp-alipay':\n\t\t\tif (err.error === 11) {\n\t\t\t\treturn '支付宝小程序网络连接失败';\n\t\t\t}\n\t\t\tbreak;\n\t\t\t\n\t\tcase 'h5':\n\t\t\tif (err.message?.includes('CORS')) {\n\t\t\t\treturn 'H5跨域请求被阻止，请检查服务器CORS配置';\n\t\t\t}\n\t\t\tbreak;\n\t\t\t\n\t\tcase 'app-plus':\n\t\t\tif (err.errMsg?.includes('timeout')) {\n\t\t\t\treturn 'App网络请求超时，请检查网络连接';\n\t\t\t}\n\t\t\tbreak;\n\t}\n\t\n\treturn `网络请求失败 (${CURRENT_PLATFORM})，请检查网络连接和服务器状态`;\n}\n\n// 获取推荐菜品\nexport function getRecommendedRecipes(preferences) {\n\treturn request('/api/recommendations', {\n\t\tmethod: 'POST',\n\t\tdata: preferences\n\t});\n}\n\n// 搜索菜品\nexport function searchRecipes(query) {\n\treturn request('/api/recipes', {\n\t\tmethod: 'GET',\n\t\tdata: { query }\n\t});\n}\n\n// 根据食材搜索菜品\nexport function searchRecipesByIngredients(ingredients) {\n\tconst query = ingredients.join(' ');\n\treturn request('/api/recipes/ingredients', {\n\t\tmethod: 'GET',\n\t\tdata: { \n\t\t\tquery,\n\t\t\tmode: 'or',\n\t\t\tlimit: 12\n\t\t}\n\t});\n}\n\n// 获取菜品详情\nexport function getRecipeById(id) {\n\treturn request(`/api/recipes/${id}`);\n}\n\n// 获取所有菜品\nexport function getAllRecipes() {\n\treturn request('/api/recipes');\n}\n\n// 转换后端数据格式为前端格式\nexport function convertRecipeToDish(recipe) {\n\t// 处理食材列表\n\tconst ingredients = recipe.yl ? recipe.yl.split(/[,，、\\n]/).filter(item => item.trim()) : [];\n\t\n\t// 处理制作步骤\n\tconst steps = recipe.steptext ? recipe.steptext.split(/\\d+[\\.、]/).filter(step => step.trim()) : [];\n\t\n\t// 处理标签\n\tconst tags = [];\n\tif (recipe.fl) tags.push(...recipe.fl.split(/[,，、]/).filter(tag => tag.trim()));\n\tif (recipe.difficulty) tags.push(getDifficultyText(recipe.difficulty));\n\tif (recipe.costtime) tags.push(recipe.costtime);\n\t\n\treturn {\n\t\tid: recipe.id,\n\t\tname: recipe.title || '未知菜品',\n\t\tdescription: recipe.desc || recipe.tip || '',\n\t\tingredients: ingredients,\n\t\tsteps: steps,\n\t\tcookingTime: recipe.costtime || '未知',\n\t\tdifficulty: getDifficultyText(recipe.difficulty || recipe['制作难易']),\n\t\ttags: tags,\n\t\tcategory: recipe.fl || '家常菜',\n\t\tscores: {\n\t\t\thealthy: recipe['健康度'] || recipe.健康度 || 5,\n\t\t\tdifficulty: recipe['制作难易'] || recipe.制作难易 || 2,\n\t\t\tvegetarian: recipe['素食偏好'] || recipe.素食偏好 || 5,\n\t\t\tspicy: recipe['辛辣程度'] || recipe.辛辣程度 || 5,\n\t\t\tsweetness: recipe['甜度'] || recipe.甜度 || 5\n\t\t},\n\t\tmatchScore: recipe.matchScore || recipe.matchPercentage || 0,\n\t\tgrade: recipe.grade || 0,\n\t\tviewnum: recipe.viewnum || 0,\n\t\tfavnum: recipe.favnum || 0\n\t};\n}\n\n// 难度等级转换\nfunction getDifficultyText(level) {\n\tconst difficultyMap = {\n\t\t1: '简单',\n\t\t2: '中等',\n\t\t3: '困难'\n\t};\n\treturn difficultyMap[level] || '中等';\n}\n\n// 计算匹配分数\nexport function calculateMatchScore(dish, preferences) {\n\tif (!dish.scores || !preferences) return 0;\n\t\n\tconst weights = {\n\t\thealthy: 0.25,\n\t\tdifficulty: 0.15,\n\t\tvegetarian: 0.2,\n\t\tspicy: 0.2,\n\t\tsweetness: 0.2\n\t};\n\t\n\tlet totalScore = 0;\n\tlet totalWeight = 0;\n\t\n\tfor (const [key, weight] of Object.entries(weights)) {\n\t\tif (dish.scores[key] !== undefined && preferences[key] !== undefined) {\n\t\t\t// 计算相似度 (1 - 差值的绝对值 / 最大可能差值)\n\t\t\tconst similarity = 1 - Math.abs(dish.scores[key] - preferences[key]) / 9;\n\t\t\ttotalScore += similarity * weight;\n\t\t\ttotalWeight += weight;\n\t\t}\n\t}\n\t\n\treturn totalWeight > 0 ? Math.round((totalScore / totalWeight) * 100) : 0;\n}\n\n// 错误处理\nexport function handleApiError(error) {\n\tconsole.error('API Error:', error);\n\t\n\tlet message = '请求失败';\n\tif (error.message) {\n\t\tif (error.message.includes('网络')) {\n\t\t\tmessage = '网络连接失败，请检查网络设置';\n\t\t} else if (error.message.includes('timeout')) {\n\t\t\tmessage = '请求超时，请稍后重试';\n\t\t} else {\n\t\t\tmessage = error.message;\n\t\t}\n\t}\n\t\n\tuni.showToast({\n\t\ttitle: message,\n\t\ticon: 'none',\n\t\tduration: 2000\n\t});\n\t\n\treturn message;\n}\n\n// 默认导出\nexport default {\n\tgetRecommendedRecipes,\n\tsearchRecipes,\n\tsearchRecipesByIngredients,\n\tgetRecipeById,\n\tgetAllRecipes,\n\tconvertRecipeToDish,\n\tcalculateMatchScore,\n\thandleApiError\n};"],"names":["getBaseUrl","getPlatform","uni"],"mappings":"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"}