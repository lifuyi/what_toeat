# 配料搜索算法实现总结

## 问题分析

您提出的嵌套搜索算法想法：
- 搜索"黄瓜 辣椒" → 先找所有含"黄瓜"的菜谱
- 在第一步结果中再搜索含"辣椒"的
- 如果有更多配料则继续嵌套搜索

## 性能分析结果

通过测试发现：

### 1. 嵌套搜索算法
- **优点**: 逻辑清晰，易于理解
- **缺点**: 
  - 多次数据库查询（N个配料需要N次查询）
  - 性能随配料数量线性下降
  - 测试显示：2个配料耗时129ms，3个配料耗时163ms

### 2. 单次SQL查询算法（推荐）
- **优点**: 
  - 只需1次数据库查询
  - 性能最优：2-3个配料仅耗时6-15ms
  - 数据库引擎优化查询
- **实现**: `WHERE yl LIKE '%黄瓜%' AND yl LIKE '%辣椒%'`

## 实现的解决方案

### 1. 改进原有 `/api/recipes` 接口

新增参数：
- `ingredient_mode`: 'and' 或 'or' (默认'or')
- `fields`: 指定搜索字段 (默认'title,id,yl')

使用示例：
```
GET /api/recipes?query=黄瓜 辣椒&ingredient_mode=and&fields=yl
```

### 2. 新增专门的配料搜索接口 `/api/recipes/ingredients`

特性：
- 提供详细的匹配信息和评分
- 支持AND/OR两种模式
- 返回匹配度百分比和匹配的具体配料

参数：
- `query`: 搜索的配料（空格分隔）
- `mode`: 'and' 或 'or' (默认'and')
- `limit`: 返回结果数量 (默认12)

返回格式：
```json
{
  "query": "黄瓜 辣椒",
  "ingredients": ["黄瓜", "辣椒"],
  "mode": "and",
  "total": 5,
  "searchTime": "8ms",
  "results": [
    {
      "title": "菜谱名称",
      "matchScore": 2,
      "matchedIngredients": ["黄瓜", "辣椒"],
      "totalIngredients": 2,
      "matchPercentage": 100,
      "...": "其他菜谱字段"
    }
  ]
}
```

## 性能对比

| 算法 | 查询次数 | 2个配料耗时 | 3个配料耗时 | 推荐度 |
|------|----------|-------------|-------------|--------|
| 嵌套搜索 | N次 | 129ms | 163ms | ❌ |
| 单次SQL查询 | 1次 | 6ms | 15ms | ✅ |
| 当前OR实现 | 1次 | 2ms | 3ms | ⚠️ (语义不同) |

## 使用建议

1. **精确搜索**: 使用AND模式，适合"必须包含所有配料"的场景
2. **广泛搜索**: 使用OR模式，适合"包含任一配料即可"的场景
3. **详细信息**: 使用 `/api/recipes/ingredients` 获取匹配度评分
4. **简单查询**: 使用改进的 `/api/recipes` 接口

## 技术要点

1. **SQL优化**: 使用单次查询替代多次嵌套查询
2. **匹配度评分**: 计算配料匹配百分比，便于排序
3. **向后兼容**: 保持原有接口功能不变
4. **灵活配置**: 支持自定义搜索字段和模式

您的嵌套搜索想法在逻辑上是正确的，但在性能上单次SQL查询更优。我们实现的方案既保证了功能需求，又优化了性能表现。